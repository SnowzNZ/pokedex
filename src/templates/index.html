<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pokedex</title>
    <link rel="stylesheet" href="../static/style.css" />
  </head>
  <body>
    <a href="/"><h1>pokedex üêõ</h1></a>
    <form action="/upload" method="post" enctype="multipart/form-data">
      <input type="file" id="csvFile" name="csvFile" accept=".csv" />
      <input type="submit" value="Import from CSV" name="submit" />
    </form>

    <input type="text" id="searchBar" placeholder="Search for Pok√©mon..." />

    <button id="insertButton">Insert New Pok√©mon</button>

    <div id="insertForm" style="display: none">
      <form id="manualInsertForm">
        <label for="number">Number:</label>
        <input type="text" id="number" name="number" /><br />
        <label for="name">Name:</label>
        <input type="text" id="name" name="name" /><br />
        <label for="form">Form:</label>
        <input type="text" id="form" name="form" /><br />
        <label for="hp">HP:</label>
        <input type="text" id="hp" name="hp" /><br />
        <label for="attack">Attack:</label>
        <input type="text" id="attack" name="attack" /><br />
        <label for="defense">Defense:</label>
        <input type="text" id="defense" name="defense" /><br />
        <label for="special_attack">Special Attack:</label>
        <input type="text" id="special_attack" name="special_attack" /><br />
        <label for="special_defense">Special Defense:</label>
        <input type="text" id="special_defense" name="special_defense" /><br />
        <label for="speed">Speed:</label>
        <input type="text" id="speed" name="speed" /><br />
        <label for="generation">Generation:</label>
        <input type="text" id="generation" name="generation" /><br />
        <label for="type1">Type 1:</label>
        <input type="text" id="type1" name="type1" /><br />
        <label for="type2">Type 2:</label>
        <input type="text" id="type2" name="type2" /><br />
        <button type="submit">Submit</button>
      </form>
    </div>

    <div class="table">
      <table id="pokemonTable">
        <thead>
          <tr>
            {% for column in cur.description %} {% if column[0] != 'id' %}
            <th>{{ column[0] }}</th>
            {% endif %} {% endfor %}
          </tr>
        </thead>
        <tbody id="pokemonTableBody">
          {% for pkm in pokemon %}
          <tr id="{{ pkm[0] }}">
            {% for value in pkm[1:] %}
            <td contenteditable="false">{{ value }}</td>
            {% endfor %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="pagination" id="searchPagination">
        <a href="{{ url_for('index', page=page-1) if page > 1 else '#' }}"
          >Previous</a
        >
        <span>Page {{ page }}</span>
        <a href="{{ url_for('index', page=page+1) }}">Next</a>
      </div>
    </div>

    {% if not pokemon %}
    <p>No Pokemon found! Maybe import some data from a CSV?</p>
    {% endif %}

    <script>
      const searchBar = document.getElementById('searchBar');
      const pokemonTableBody = document.getElementById('pokemonTableBody');
      const searchPagination = document.getElementById('searchPagination');
      const columns = [{% for column in cur.description %}{% if column[0] != 'id' %}"{{ column[0] }}",{% endif %}{% endfor %}];
      let currentPage = 1;

      async function fetchResults(query, page = 1) {
        const response = await fetch(`/search?query=${query}&page=${page}`);
        const results = await response.json();
        return results;
      }

      function renderTable(data) {
        pokemonTableBody.innerHTML = '';
        data.forEach(pokemon => {
          const row = document.createElement('tr');
          columns.forEach(column => {
            const cell = document.createElement('td');
            cell.textContent = pokemon[column];
            row.appendChild(cell);
          });
          pokemonTableBody.appendChild(row);
        });
      }

      function renderPagination(query, page) {
        searchPagination.innerHTML = '';
        const prevPage = document.createElement('a');
        prevPage.href = '#';
        prevPage.textContent = 'Previous';
        prevPage.onclick = () => {
          if (page > 1) {
            currentPage--;
            updateSearch(query, currentPage);
          }
        };
        searchPagination.appendChild(prevPage);

        const pageSpan = document.createElement('span');
        pageSpan.textContent = `Page ${page}`;
        searchPagination.appendChild(pageSpan);

        const nextPage = document.createElement('a');
        nextPage.href = '#';
        nextPage.textContent = 'Next';
        nextPage.onclick = () => {
          currentPage++;
          updateSearch(query, currentPage);
        };
        searchPagination.appendChild(nextPage);
      }

      async function updateSearch(query, page = 1) {
        const results = await fetchResults(query, page);
        renderTable(results);
        renderPagination(query, page);
      }

      searchBar.addEventListener('input', () => {
        const query = searchBar.value;
        currentPage = 1;
        updateSearch(query, currentPage);
      });

      // Show insert form popup
      const insertButton = document.getElementById('insertButton');
      const insertForm = document.getElementById('insertForm');
      insertButton.addEventListener('click', () => {
        insertForm.style.display = 'block';
      });

      // Handle form submission
      const manualInsertForm = document.getElementById('manualInsertForm');
      manualInsertForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(manualInsertForm);
        const data = Object.fromEntries(formData);
        const response = await fetch('/insert', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        });
        if (response.ok) {
          insertForm.style.display = 'none';
          manualInsertForm.reset();
          updateSearch(searchBar.value, currentPage);
        }
      });
    </script>
  </body>
</html>
